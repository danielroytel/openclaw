services:
  moltbot-gateway:
    image: ghcr.io/moltbot/moltbot:main
    container_name: moltbot-gateway
    restart: unless-stopped
    user: "0:0"

    environment:
      HOME: /home/node
      TERM: xterm-256color
      SETUP_PASSWORD: ${SETUP_PASSWORD}
      CLAWDBOT_GATEWAY_TOKEN: ${CLAWDBOT_GATEWAY_TOKEN}
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE}
      MOLTBOT_STATE_DIR: /home/node/.clawdbot
      CLAWDBOT_STATE_DIR: /home/node/.clawdbot
      MOLTBOT_GATEWAY__MODE: ${MOLTBOT_GATEWAY__MODE:-local}
      CLAWDBOT_GATEWAY_BIND: ${CLAWDBOT_GATEWAY_BIND:-lan}
      PORT: ${PORT:-8080}
      NODE_ENV: ${NODE_ENV:-production}

    volumes:
      - moltbot-config:/home/node/.clawdbot
      - moltbot-workspace:/home/node/clawd

    ports:
      - "18789:18789"
      - "18790:18790"

    labels:
      - traefik.enable=true
      - traefik.http.routers.moltbot.rule=Host(`moltbot.your-domain.com`)
      - traefik.http.routers.moltbot.entrypoints=websecure
      - traefik.http.routers.moltbot.tls=true
      - traefik.http.routers.moltbot.tls.certresolver=letsencrypt
      - traefik.http.routers.moltbot.service=moltbot
      - traefik.http.services.moltbot.loadbalancer.server.port=18789

    healthcheck:
      test: ["CMD", "sh", "-c", "su node -c 'node dist/index.js health --token \"$CLAWDBOT_GATEWAY_TOKEN\"'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    command:
      - sh
      - -c
      - |
        # Fix volume permissions on startup
        mkdir -p /home/node/.clawdbot/cron /home/node/clawd/canvas /home/node/.clawdbot/agents /home/node/.clawdbot/sessions
        chown -R node:node /home/node/.clawdbot /home/node/clawd
        # Drop to node user and start gateway
        exec su node -c "cd /home/node && exec node dist/index.js gateway --bind '${CLAWDBOT_GATEWAY_BIND:-lan}' --port 18789 --allow-unconfigured"

volumes:
  moltbot-config:
    driver: local
  moltbot-workspace:
    driver: local

networks:
  default:
    name: moltbot-network
