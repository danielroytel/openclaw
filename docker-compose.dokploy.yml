services:
  openclaw-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    image: ${OPENCLAW_IMAGE:-openclaw:local}
    container_name: openclaw-gateway
    restart: unless-stopped
    init: true

    environment:
      HOME: /home/node
      TERM: xterm-256color
      SETUP_PASSWORD: ${SETUP_PASSWORD}
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      CLAWDBOT_GATEWAY_TOKEN: ${CLAWDBOT_GATEWAY_TOKEN} # Legacy fallback
      OPENCLAW_STATE_DIR: /home/node/.openclaw
      CLAWDBOT_STATE_DIR: /home/node/.clawdbot # Legacy fallback
      MOLTBOT_STATE_DIR: /home/node/.clawdbot # Legacy fallback
      OPENCLAW_GATEWAY__MODE: ${OPENCLAW_GATEWAY__MODE:-local}
      MOLTBOT_GATEWAY__MODE: ${MOLTBOT_GATEWAY__MODE:-local} # Legacy fallback
      OPENCLAW_GATEWAY_BIND: ${OPENCLAW_GATEWAY_BIND:-lan}
      CLAWDBOT_GATEWAY_BIND: ${CLAWDBOT_GATEWAY_BIND:-lan} # Legacy fallback
      OPENCLAW_GATEWAY_PORT: ${OPENCLAW_GATEWAY_PORT:-18789}
      PORT: ${PORT:-8080}
      NODE_ENV: ${NODE_ENV:-production}
      # Optional: Claude provider
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE}
      # Optional: Doppler secrets (configure manually in container)
      DOPPLER_API_KEY: ${DOPPLER_API_KEY}
      # Optional: Ollama local LLMs
      OLLAMA_API_KEY: ${OLLAMA_API_KEY:-ollama-local}

    volumes:
      - openclaw-config:/home/node/.openclaw
      - openclaw-workspace:/home/node/openclaw
      # Legacy fallback mounts (for existing volumes)
      - moltbot-config:/home/node/.clawdbot
      - moltbot-workspace:/home/node/clawd

    ports:
      - "${OPENCLAW_GATEWAY_PORT:-18789}:18789"
      - "${OPENCLAW_BRIDGE_PORT:-18790}:18790"

    labels:
      - traefik.enable=true
      - traefik.http.routers.openclaw.rule=Host(`openclaw.your-domain.com`)
      - traefik.http.routers.openclaw.entrypoints=websecure
      - traefik.http.routers.openclaw.tls=true
      - traefik.http.routers.openclaw.tls.certresolver=letsencrypt
      - traefik.http.routers.openclaw.service=openclaw
      - traefik.http.services.openclaw.loadbalancer.server.port=18789

    healthcheck:
      test: ["CMD", "node", "dist/index.js", "health", "--token", "${OPENCLAW_GATEWAY_TOKEN:-${CLAWDBOT_GATEWAY_TOKEN}}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    command:
      [
        "node",
        "dist/index.js",
        "gateway",
        "--bind",
        "${OPENCLAW_GATEWAY_BIND:-${CLAWDBOT_GATEWAY_BIND:-lan}}",
        "--port",
        "${OPENCLAW_GATEWAY_PORT:-18789}",
        "--allow-unconfigured"
      ]

volumes:
  openclaw-config:
    driver: local
  openclaw-workspace:
    driver: local
  # Legacy volumes for backward compatibility
  moltbot-config:
    driver: local
  moltbot-workspace:
    driver: local

networks:
  default:
    name: openclaw-network
