services:
  moltbot-gateway:
    image: ghcr.io/moltbot/moltbot:main
    container_name: moltbot-gateway
    restart: unless-stopped
    user: "0:0"

    environment:
      HOME: /home/node
      TERM: xterm-256color
      SETUP_PASSWORD: ${SETUP_PASSWORD}
      CLAWDBOT_GATEWAY_TOKEN: ${CLAWDBOT_GATEWAY_TOKEN}
      CLAUDE_AI_SESSION_KEY: ${CLAUDE_AI_SESSION_KEY}
      CLAUDE_WEB_SESSION_KEY: ${CLAUDE_WEB_SESSION_KEY}
      CLAUDE_WEB_COOKIE: ${CLAUDE_WEB_COOKIE}
      MOLTBOT_STATE_DIR: /home/node/.clawdbot
      CLAWDBOT_STATE_DIR: /home/node/.clawdbot
      MOLTBOT_GATEWAY__MODE: ${MOLTBOT_GATEWAY__MODE:-local}
      CLAWDBOT_GATEWAY_BIND: ${CLAWDBOT_GATEWAY_BIND:-lan}
      PORT: ${PORT:-8080}
      NODE_ENV: ${NODE_ENV:-production}

    volumes:
      - moltbot-config:/home/node/.clawdbot
      - moltbot-workspace:/home/node/clawd

    ports:
      - "18789:18789"
      - "18790:18790"

    labels:
      - traefik.enable=true
      - traefik.http.routers.moltbot.rule=Host(`moltbot.your-domain.com`)
      - traefik.http.routers.moltbot.entrypoints=websecure
      - traefik.http.routers.moltbot.tls=true
      - traefik.http.routers.moltbot.tls.certresolver=letsencrypt
      - traefik.http.routers.moltbot.service=moltbot
      - traefik.http.services.moltbot.loadbalancer.server.port=18789

    healthcheck:
      test: ["CMD", "sh", "-c", "su node -c 'node /app/dist/index.js health --token \"$CLAWDBOT_GATEWAY_TOKEN\"'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    command:
      - sh
      - -c
      - |
        # Install prerequisites
        apt-get update -qq && apt-get install -y curl git

        # Create base directories
        mkdir -p /home/node/.clawdbot/cron /home/node/clawd/canvas /home/node/.clawdbot/agents /home/node/.clawdbot/sessions
        mkdir -p /usr/local/lib/node_modules /usr/local/bin /usr/local/share /usr/local/lib
        mkdir -p /home/node/.npm /home/node/.cache /home/node/.cache/Homebrew
        mkdir -p /home/node/.config/git /home/linuxbrew/.linuxbrew

        # Install Homebrew if not already installed
        if ! command -v brew >/dev/null 2>&1; then
          echo "Installing Homebrew..."
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)" </dev/null
        fi

        # BLANKET: Own EVERYTHING as node, open all permissions
        chown -R node:node /home/node /home/linuxbrew /usr/local /usr/local/lib/node_modules /usr/local/bin /usr/local/share /usr/local/lib
        chmod -R u+w /home/node /home/linuxbrew /usr/local /usr/local/lib/node_modules /usr/local/bin /usr/local/share /usr/local/lib

        # Create moltbot CLI wrapper for easy command execution
        cat > /usr/local/bin/moltbot << 'EOF'
        #!/bin/sh
        # Moltbot CLI wrapper - simplifies running commands as the node user
        # Usage: moltbot <command> [args...]

        if [ "$(id -u)" != "node" ]; then
          exec su node -c "node /app/dist/index.js $*"
        else
          exec node /app/dist/index.js "$@"
        fi
        EOF
        chmod +x /usr/local/bin/moltbot
        chown node:node /usr/local/bin/moltbot

        # Drop to node user and start gateway (app is in /app)
        exec su node -c "exec node /app/dist/index.js gateway --bind '${CLAWDBOT_GATEWAY_BIND:-lan}' --port 18789 --allow-unconfigured"

  tailscale:
    image: tailscale/tailscale:latest
    container_name: moltbot-tailscale
    restart: unless-stopped
    privileged: true
    network_mode: service:moltbot-gateway

    environment:
      TS_AUTHKEY: ${TS_AUTHKEY}
      TS_STATE_DIR: /var/lib/tailscale
      TS_HOSTNAME: ${TAILSCALE_HOSTNAME:-moltbot}
      TS_USERSPACE: false

    volumes:
      - moltbot-tailscale:/var/lib/tailscale

    cap_add:
      - NET_ADMIN
      - SYS_MODULE

    command:
      - sh
      - -c
      - |
        # Start the Tailscale daemon in background
        tailscaled --tun=userspace-networking --state=/var/lib/tailscale/tailscaled.state --socket=/var/run/tailscale/tailscaled.sock > /tmp/tailscaled.log 2>&1 &
        TAILSCALED_PID=$!

        # Wait for daemon socket to be ready
        echo "Waiting for tailscaled to start..."
        for i in $(seq 1 30); do
          if [ -S /var/run/tailscale/tailscaled.sock ]; then
            echo "tailscaled is ready!"
            break
          fi
          echo "Waiting... ($i/30)"
          sleep 1
        done

        # Give daemon a moment to fully initialize
        sleep 2

        # Authenticate with Tailscale
        echo "Authenticating with Tailscale..."
        tailscale up --authkey="$TS_AUTHKEY"

        # Set the machine hostname (this changes the DNS name used for Funnel)
        echo "Setting hostname to $TS_HOSTNAME..."
        tailscale set --hostname="$TS_HOSTNAME"

        # Enable Funnel on port 18789 (provides HTTPS with valid cert)
        echo "Enabling Funnel..."
        tailscale funnel --bg --https=18789 localhost:18789

        # Show status
        tailscale status

        # Keep container alive by monitoring the daemon
        echo "Tailscale is running. Keeping container alive..."
        wait $TAILSCALED_PID

volumes:
  moltbot-config:
    driver: local
  moltbot-workspace:
    driver: local
  moltbot-tailscale:
    driver: local

networks:
  default:
    name: moltbot-network
